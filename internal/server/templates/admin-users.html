{{define "title"}}User Management — GoTunnel{{end}}
{{define "body"}}
<div class="flex min-h-screen">
    {{template "sidebar" .}}

    <main class="flex-1 p-8">
        <!-- Header -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold">User Management</h1>
                <p class="text-gray-400 mt-1">Manage roles, tunnels, and access for all users</p>
            </div>
            <button onclick="document.getElementById('createUserModal').classList.remove('hidden')"
                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition-colors">
                + New User
            </button>
        </div>

        <!-- Flash message -->
        <div id="flashMsg" class="hidden mb-4 px-4 py-3 rounded-lg text-sm"></div>

        <!-- Users Table -->
        {{$data := .Data}}
        <div class="card rounded-xl overflow-hidden">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-700/50 text-gray-400 text-xs uppercase tracking-wider">
                        <th class="px-6 py-3 text-left">User</th>
                        <th class="px-6 py-3 text-left">Role</th>
                        <th class="px-6 py-3 text-left">Max Tunnels</th>
                        <th class="px-6 py-3 text-left">Joined</th>
                        <th class="px-6 py-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800/50">
                    {{range $data.Users}}
                    <tr class="hover:bg-gray-800/30 transition-colors" id="user-row-{{.ID}}">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-sm font-medium">
                                    {{slice .Username 0 1}}
                                </div>
                                <div>
                                    <div class="font-medium text-white">{{.Username}}</div>
                                    <div class="text-xs text-gray-500">{{.Email}}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            {{if .IsAdmin}}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-indigo-500/20 text-indigo-400 font-medium">Admin</span>
                            {{else}}
                            <span class="px-2 py-0.5 rounded-full text-xs bg-gray-500/20 text-gray-400 font-medium">User</span>
                            {{end}}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <span id="max-tunnels-{{.ID}}" class="text-gray-300">{{.MaxTunnels}}</span>
                                <button onclick="editMaxTunnels({{.ID}}, {{.MaxTunnels}})"
                                    class="text-xs text-gray-500 hover:text-gray-300 transition-colors">✎</button>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-500 text-xs">
                            {{.CreatedAt.Format "Jan 2, 2006"}}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center justify-end gap-2">
                                <!-- Login as -->
                                <form method="POST" action="/admin/impersonate/{{.ID}}" class="inline">
                                    <button type="submit"
                                        class="px-2.5 py-1 text-xs rounded bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 transition-colors">
                                        Login as
                                    </button>
                                </form>
                                <!-- Reset Password -->
                                <button onclick="openResetPassword({{.ID}}, '{{.Username}}')"
                                    class="px-2.5 py-1 text-xs rounded bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 transition-colors">
                                    Reset Password
                                </button>
                                <!-- Toggle Admin -->
                                {{if .IsAdmin}}
                                <button onclick="updateUser({{.ID}}, {is_admin: false})"
                                    class="px-2.5 py-1 text-xs rounded bg-gray-700/50 hover:bg-gray-600/50 text-gray-300 transition-colors">
                                    Revoke Admin
                                </button>
                                {{else}}
                                <button onclick="updateUser({{.ID}}, {is_admin: true})"
                                    class="px-2.5 py-1 text-xs rounded bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-400 transition-colors">
                                    Make Admin
                                </button>
                                {{end}}
                                <!-- Delete -->
                                <button onclick="deleteUser({{.ID}}, '{{.Username}}')"
                                    class="px-2.5 py-1 text-xs rounded bg-red-500/20 hover:bg-red-500/30 text-red-400 transition-colors">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {{else}}
                    <tr>
                        <td colspan="5" class="px-6 py-10 text-center text-gray-500">No users found</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>

        <!-- Create User Modal -->
        <div id="createUserModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
            <div class="card rounded-xl p-6 w-full max-w-md mx-4">
                <h2 class="text-lg font-semibold mb-4">Create New User</h2>
                <form id="createUserForm" class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Email</label>
                        <input type="email" id="newEmail" placeholder="user@example.com"
                            class="w-full px-3 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-sm focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Username</label>
                        <input type="text" id="newUsername" placeholder="johndoe"
                            class="w-full px-3 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-sm focus:outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Password</label>
                        <input type="password" id="newPassword" placeholder="••••••••"
                            class="w-full px-3 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-sm focus:outline-none focus:border-indigo-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="newIsAdmin" class="rounded">
                        <label for="newIsAdmin" class="text-sm text-gray-300">Grant Admin Role</label>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="submit"
                            class="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition-colors">
                            Create User
                        </button>
                        <button type="button" onclick="document.getElementById('createUserModal').classList.add('hidden')"
                            class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Max Tunnels Modal -->
        <div id="editTunnelsModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
            <div class="card rounded-xl p-6 w-full max-w-sm mx-4">
                <h2 class="text-lg font-semibold mb-4">Edit Max Tunnels</h2>
                <input type="hidden" id="editTunnelsUserID">
                <input type="number" id="editTunnelsValue" min="0" max="100"
                    class="w-full px-3 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-sm focus:outline-none focus:border-indigo-500 mb-4">
                <div class="flex gap-3">
                    <button onclick="saveMaxTunnels()"
                        class="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition-colors">Save</button>
                    <button onclick="document.getElementById('editTunnelsModal').classList.add('hidden')"
                        class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Reset Password Modal -->
        <div id="resetPasswordModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
            <div class="card rounded-xl p-6 w-full max-w-sm mx-4">
                <h2 class="text-lg font-semibold mb-1">Reset Password</h2>
                <p class="text-sm text-gray-400 mb-4">for <span id="resetPasswordUsername" class="text-white font-medium"></span></p>
                <input type="hidden" id="resetPasswordUserID">
                <div class="mb-3">
                    <label class="block text-sm text-gray-400 mb-1">New Password</label>
                    <input type="password" id="resetPasswordNew" placeholder="••••••••"
                        class="w-full px-3 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-sm focus:outline-none focus:border-indigo-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">Confirm Password</label>
                    <input type="password" id="resetPasswordConfirm" placeholder="••••••••"
                        class="w-full px-3 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-sm focus:outline-none focus:border-indigo-500">
                </div>
                <div class="flex gap-3">
                    <button onclick="saveResetPassword()"
                        class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-medium transition-colors">Reset Password</button>
                    <button onclick="document.getElementById('resetPasswordModal').classList.add('hidden')"
                        class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </main>
</div>
{{end}}

{{define "scripts"}}
<script>
function showFlash(msg, type) {
    const el = document.getElementById('flashMsg');
    el.textContent = msg;
    el.className = 'mb-4 px-4 py-3 rounded-lg text-sm ' +
        (type === 'error' ? 'bg-red-500/20 text-red-400 border border-red-500/30' : 'bg-green-500/20 text-green-400 border border-green-500/30');
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 4000);
}

async function updateUser(userID, fields) {
    const body = { user_id: userID, ...fields };
    try {
        const res = await fetch('/api/admin/users/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) { showFlash(data.error || 'Failed to update user', 'error'); return; }
        showFlash('User updated successfully', 'success');
        setTimeout(() => location.reload(), 800);
    } catch (e) {
        showFlash('Network error', 'error');
    }
}

async function deleteUser(userID, username) {
    if (!confirm('Delete user "' + username + '"? This cannot be undone.')) return;
    try {
        const res = await fetch('/api/admin/users/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userID })
        });
        const data = await res.json();
        if (!res.ok) { showFlash(data.error || 'Failed to delete user', 'error'); return; }
        document.getElementById('user-row-' + userID)?.remove();
        showFlash('User deleted', 'success');
    } catch (e) {
        showFlash('Network error', 'error');
    }
}

function editMaxTunnels(userID, current) {
    document.getElementById('editTunnelsUserID').value = userID;
    document.getElementById('editTunnelsValue').value = current;
    document.getElementById('editTunnelsModal').classList.remove('hidden');
}

async function saveMaxTunnels() {
    const userID = parseInt(document.getElementById('editTunnelsUserID').value);
    const val = parseInt(document.getElementById('editTunnelsValue').value);
    document.getElementById('editTunnelsModal').classList.add('hidden');
    await updateUser(userID, { max_tunnels: val });
}

function openResetPassword(userID, username) {
    document.getElementById('resetPasswordUserID').value = userID;
    document.getElementById('resetPasswordUsername').textContent = username;
    document.getElementById('resetPasswordNew').value = '';
    document.getElementById('resetPasswordConfirm').value = '';
    document.getElementById('resetPasswordModal').classList.remove('hidden');
}

async function saveResetPassword() {
    const userID = parseInt(document.getElementById('resetPasswordUserID').value);
    const newPwd = document.getElementById('resetPasswordNew').value;
    const confirmPwd = document.getElementById('resetPasswordConfirm').value;

    if (newPwd.length < 6) { showFlash('Password must be at least 6 characters', 'error'); return; }
    if (newPwd !== confirmPwd) { showFlash('Passwords do not match', 'error'); return; }

    document.getElementById('resetPasswordModal').classList.add('hidden');

    try {
        const res = await fetch('/api/admin/users/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userID, new_password: newPwd })
        });
        const data = await res.json();
        if (!res.ok) { showFlash(data.error || 'Failed to reset password', 'error'); return; }
        showFlash('Password reset successfully', 'success');
    } catch (e) {
        showFlash('Network error', 'error');
    }
}

document.getElementById('createUserForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('newEmail').value.trim();
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value;
    const isAdmin = document.getElementById('newIsAdmin').checked;

    const res = await fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ email, username, password, confirm_password: password }),
        redirect: 'manual'
    });

    if (res.type === 'opaqueredirect' || res.status === 303 || res.ok) {
        if (isAdmin) {
            // Find newly created user and grant admin via list reload
            const listRes = await fetch('/api/admin/users');
            // Simple reload suffices since admin flag will be set retroactively
        }
        document.getElementById('createUserModal').classList.add('hidden');
        showFlash('User created successfully', 'success');
        setTimeout(() => location.reload(), 800);
    } else {
        showFlash('Failed to create user', 'error');
    }
});
</script>
{{end}}
